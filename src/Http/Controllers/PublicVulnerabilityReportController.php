<?php

namespace Whozidis\HallOfFame\Http\Controllers;

use Botble\Base\Facades\Assets;
use Botble\Base\Facades\PageTitle;
use Botble\Base\Forms\FormBuilder;
use Botble\Base\Http\Controllers\BaseController;
use Botble\Base\Http\Responses\BaseHttpResponse;
use Botble\Media\Facades\RvMedia;
use Botble\SeoHelper\Facades\SeoHelper;
use Botble\Theme\Facades\Theme;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Mail;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\View;
use Whozidis\HallOfFame\Forms\PublicVulnerabilityReportForm;
use Whozidis\HallOfFame\Http\Requests\PublicVulnerabilityReportRequest;
use Whozidis\HallOfFame\Mail\VulnerabilityReportSubmitted;
use Whozidis\HallOfFame\Models\VulnerabilityAttachment;
use Whozidis\HallOfFame\Models\VulnerabilityReport;

class PublicVulnerabilityReportController extends BaseController
{
    public function index()
    {
        if (! is_plugin_active('hall-of-fame')) {
            abort(404);
        }

        // Set the Hall of Fame theme layout
        Theme::setLayout('hall-of-fame');

        // Set page title and SEO
        PageTitle::setTitle('Hall of Fame');
        SeoHelper::setTitle('Security Hall of Fame')
            ->setDescription('Recognizing security researchers who help keep our platform secure');

        // Set breadcrumbs  
        Theme::breadcrumb()
            ->add(__('Home'), route('public.index'))
            ->add('Hall of Fame', route('public.hall-of-fame.index'));
        
        try {
            $reports = VulnerabilityReport::with('researcher')
                ->where('status', 'published')
                ->orderBy('created_at', 'desc')
                ->paginate(20);
        } catch (\Exception $e) {
            Log::error('Error fetching vulnerability reports: ' . $e->getMessage());
            $reports = collect();
        }

        // Use theme integration with correct method
        return Theme::of('plugins/hall-of-fame::hall-of-fame', compact('reports'))->render();
    }

    public function create()
    {
        if (! is_plugin_active('hall-of-fame')) {
            abort(404);
        }

        // Set the Hall of Fame theme layout
        Theme::setLayout('hall-of-fame');

        // Set page title and breadcrumbs
        PageTitle::setTitle('Submit Vulnerability Report');
        Theme::breadcrumb()
            ->add(__('Home'), route('public.index'))
            ->add('Hall of Fame', route('public.hall-of-fame.index'))
            ->add('Submit Report', route('public.vulnerability-reports.create'));

        // We'll keep authentication to submit reports, but use a more generic approach
        if (! Auth::check()) {
            // Redirect to the login page - make sure this route exists
            return redirect()->route('public.hall-of-fame.auth.login', ['redirect' => route('public.vulnerability-reports.create')]);
        }

        // Use theme integration for submit form with correct method
        return Theme::of('plugins/hall-of-fame::public.submit')->render();
    }

    public function store(PublicVulnerabilityReportRequest $request, BaseHttpResponse $response)
    {
        $data = $request->validated();
        unset($data['attachments'], $data['privacy_policy'], $data['g-recaptcha-response']);
        
        $vulnerabilityReport = new VulnerabilityReport();
        $vulnerabilityReport->fill($data);
        $vulnerabilityReport->status = 'pending';
        $vulnerabilityReport->user_id = Auth::check() ? Auth::user()->getKey() : null;
        $vulnerabilityReport->save();

        // Send notification email
        try {
            Mail::to($vulnerabilityReport->researcher_email)
                ->send(new VulnerabilityReportSubmitted($vulnerabilityReport));
        } catch (\Exception $exception) {
            info('Error sending vulnerability report notification: ' . $exception->getMessage());
        }

        // Handle attachments
        $files = $request->validated()['attachments'] ?? [];
        if (!empty($files)) {
            foreach ($files as $file) {
                if ($file->isValid()) {
                    $fileUpload = RvMedia::handleUpload($file, 0, 'hall-of-fame/attachments');
                    if ($fileUpload['error'] === false) {
                        $attachment = new VulnerabilityAttachment();
                        $attachment->vulnerability_report_id = $vulnerabilityReport->id;
                        $attachment->file_name = $file->getClientOriginalName();
                        $attachment->file_path = $fileUpload['data']->url;
                        $attachment->file_size = $file->getSize();
                        $attachment->file_mime = $file->getMimeType();

                        // Determine file type
                        $mimeType = $file->getMimeType();
                        if (str_starts_with($mimeType, 'image/')) {
                            $attachment->file_type = 'image';
                        } elseif (str_starts_with($mimeType, 'video/')) {
                            $attachment->file_type = 'video';
                        } else {
                            $attachment->file_type = 'document';
                        }

                        $attachment->save();
                    }
                }
            }
        }

        // Set theme layout and breadcrumbs
        \Botble\Theme\Facades\Theme::setLayout('hall-of-fame');
        \Botble\Theme\Facades\Theme::breadcrumb()
            ->add(__('Home'), route('public.index'))
            ->add('Hall of Fame', route('public.hall-of-fame.index'))
            ->add('Thank You');

        return \Botble\Theme\Facades\Theme::of('plugins/hall-of-fame::public.thank-you', compact('vulnerabilityReport'))->render();
    }

    public function show($id)
    {
        $report = VulnerabilityReport::where('is_published', true)
            ->where('status', 'published')
            ->where('id', $id)
            ->firstOrFail();

        // Set theme layout and breadcrumbs
        \Botble\Theme\Facades\Theme::setLayout('hall-of-fame');
        \Botble\Theme\Facades\Theme::breadcrumb()
            ->add(__('Home'), route('public.index'))
            ->add('Hall of Fame', route('public.hall-of-fame.index'))
            ->add($report->title);

        return \Botble\Theme\Facades\Theme::of('plugins/hall-of-fame::public.show', compact('report'))->render();
    }

    public function hall()
    {
        $years = VulnerabilityReport::where('status', 'published')
            ->where('is_published', true)
            ->selectRaw('YEAR(created_at) as year')
            ->distinct()
            ->orderBy('year', 'desc')
            ->pluck('year');

        $reports = [];
        foreach ($years as $year) {
            $reports[$year] = VulnerabilityReport::where('status', 'published')
                ->where('is_published', true)
                ->whereYear('created_at', $year)
                ->orderBy('created_at', 'desc')
                ->get();
        }

        // Set theme layout and breadcrumbs
        \Botble\Theme\Facades\Theme::setLayout('hall-of-fame');
        \Botble\Theme\Facades\Theme::breadcrumb()
            ->add(__('Home'), route('public.index'))
            ->add('Hall of Fame', route('public.hall-of-fame.index'));

        return \Botble\Theme\Facades\Theme::of('plugins/hall-of-fame::public.hall', compact('reports', 'years'))->render();
    }

    public function myReports(Request $request)
    {
        if (!$request->hasValidSignature()) {
            abort(401);
        }

        $reports = VulnerabilityReport::where('researcher_email', $request->get('email'))
            ->orderBy('created_at', 'desc')
            ->paginate(10);

        // Set theme layout and breadcrumbs
        \Botble\Theme\Facades\Theme::setLayout('hall-of-fame');
        \Botble\Theme\Facades\Theme::breadcrumb()
            ->add(__('Home'), route('public.index'))
            ->add('Hall of Fame', route('public.hall-of-fame.index'))
            ->add('My Reports');

        return \Botble\Theme\Facades\Theme::of('plugins/hall-of-fame::public.my-reports', compact('reports'))->render();
    }
}
